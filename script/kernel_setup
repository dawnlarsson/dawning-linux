#!/bin/sh
source script/common

kernel_extract_dir="linux/"
download_artifacts_dir="artifacts/"
keys_dir=$download_artifacts_dir"keys/"
trusted_keys="torvalds@kernel.org gregkh@kernel.org"
kernel_version="6.15"
kernel_download="https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.15.tar.xz"
kernel_pgp="
-----BEGIN PGP SIGNATURE-----
Comment: This signature is for the .tar version of the archive
Comment: git archive --format tar --prefix=linux-6.15/ v6.15
Comment: git version 2.49.0

iQIzBAABCgAdFiEEZH8oZUiU471FcZm+ONu9yGCSaT4FAmgz8foACgkQONu9yGCS
aT6Jtg//S8tWYM3FmFF7t1B4glOdM1jpIUPgKzPkQaio1aqaJnXWWydyJJGlV5U3
GexAzgKzL4M8aTtIU+2zwDW3XkUkRk7xAcfcKGAlyDxaAophRqh5moDPoABoP8Ae
HILQadXlogFeKtxXUyVQlj4tJZF+6cNeCABB7EbfZ+CZ4lbgsBdh7KKmulebwgZx
1ZLOfxhzN6iNVdJioCoUwQY4mmxKo48bT9/opXDs6uTJcQu/WYs52g3m3HCu1UVY
t/kGzuz+zG2WorHgP68zeoyN9OyLK/m3teTYmwXD8eBfzZSabzXdGnzqoUmtXigh
vQpUhA7x/b2hXjezcoUuF8W33J1LLAFK/fowMDu+4NC2+kV47YrN+ltERFJzYrRJ
NnE+0LB6ND4AiCMCnGTxVj6ORQf3IoLGmtPnmX9GkbXz4ARI3+Y+bc2QlP/Lf0q8
eOWwiUIT51E11k5MP8Atjuh7kAp2vUzAQOn1FfLxXTdzPuwxbQJIoEBKrrZtB+qx
oIvXWC7ZL4mrLdDLoFIEYT9KbdeS0LLFe2IP77k50GYKqF5ZBSuI6ZYzOchcg63D
YCxukFzxhgc3VGLYyhGRm8L8r8yd7xUSdvF1Ku5a45ha1pnqkvnb9RB1PwM1WlJe
Fy/esfN/Xb00MBwxhDGM4YHVgLgECoix2VPtqFhAYqZp2Bk71zI=
=Cheb
-----END PGP SIGNATURE-----
"

kernel_tarball=$download_artifacts_dir"linux-$kernel_version.tar"
kernel_archive=$kernel_tarball".xz"

if [ -d $kernel_extract_dir ]; then
    echo $BOLD "Kernel already extracted..." $RESET
    exit 0
fi

extract_kernel() {
    echo $BOLD "Checking kernel signature" $RESET
    gpg --locate-keys $trusted_keys

    unxz -k $kernel_archive

    echo "$kernel_pgp" >$kernel_tarball".sign"

    gpg --verify $kernel_tarball".sign" $kernel_tarball

    tar -xf $kernel_tarball --strip-components=1 -C $kernel_extract_dir

    rm $kernel_tarball

    echo $BOLD "Kernel extracted to $kernel_extract_dir" $RESET
}

is_file $kernel_archive ||
    curl -L $kernel_download -o $kernel_archive

mkdir -p $download_artifacts_dir
mkdir -p $kernel_extract_dir

extract_kernel
