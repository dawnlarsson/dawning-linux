#!/bin/sh
source script/common

kernel_extract_dir="linux/" 
download_artifacts_dir="artifacts/"
keys_dir=$download_artifacts_dir"keys/"
trusted_keys="torvalds@kernel.org gregkh@kernel.org"
kernel_version="6.14.4"
kernel_download="https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.14.4.tar.xz"
kernel_pgp="
-----BEGIN PGP SIGNATURE-----
Comment: This signature is for the .tar version of the archive
Comment: git archive --format tar --prefix=linux-6.14.4/ v6.14.4
Comment: git version 2.49.0

iQIzBAABCAAdFiEEZH8oZUiU471FcZm+ONu9yGCSaT4FAmgLTXoACgkQONu9yGCS
aT4HLQ/9G7N5wHAGgq70fONViUxzOXwhJoy3uJRMxPTyBdYWSdCgY/HLKk/ZyDxT
JnohqmR8qjE0uGXYHVN39prL8vnQa5kgm6rW80jbXu3gmE+xnKen0CsHUyM3B1iu
P/yPcroy5K1z17YUuZ4jeO1spD3jg9RjcoL3yjVIjmE0I9wUOW/tWglBbm5k4a0l
6TIx01TJaP3jNj9mFeNivxURpGruc+Vd5/MAY79l+VvKBPeC14XN8be2dtst5q2X
Ch3dii67rI8SBVeHF0zSsINNf1JxFHlBveKqnGmxwtPa3dF4SD0Mo9yjRP/81iNg
EySMXmVJ8e5oNz3w5LHvK69WdOWAPY/W8UPC2Zbc1pZ0p/SS1e5ry0FYWwpCteIN
1XFYypQIW6UM5+FuBvOLAikRkdlWoqV9UwGWHinu7j5cxtKiasGNV3sMwjQeANbn
iovABh3pZLJVGskF5UMtN95FW+qA5PD7mrsFzBo4mR9pb2Q6A6z9O6eGMkoJyZzw
NxvU1vEFBwG7tTw7VKVnznT3gmr3oc0valm4Vc9uWz+ltgRToQmpjTV7S/Jfsh52
10Q4fDgDidukQvWGy1H8SE6RcU9itSOKKhqqjJ5FMebCHpv/xqIuax4fpy3oBpLU
R8UHFpk1efbnjvNfwLQUcBtzzBpRPQ5tcpeChJf7zj9gp00tfwQ=
=PuA2
-----END PGP SIGNATURE-----
"

kernel_tarball=$download_artifacts_dir"linux-$kernel_version.tar"
kernel_archive=$kernel_tarball".xz"

if [ -d $kernel_extract_dir ]; then
    echo $BOLD "Kernel already extracted..." $RESET
    exit 0
fi

extract_kernel() {
    echo $BOLD "Checking kernel signature" $RESET
    gpg --locate-keys $trusted_keys

    unxz -k $kernel_archive

    echo "$kernel_pgp" > $kernel_tarball".sign"

    gpg --verify $kernel_tarball".sign" $kernel_tarball

    tar -xf $kernel_tarball --strip-components=1 -C $kernel_extract_dir

    rm $kernel_tarball

    echo $BOLD "Kernel extracted to $kernel_extract_dir" $RESET
}

is_file $kernel_archive || \
    curl -L $kernel_download -o $kernel_archive

mkdir -p $download_artifacts_dir
mkdir -p $kernel_extract_dir

extract_kernel
